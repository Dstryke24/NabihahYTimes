<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>The Taawun Times Mini Crossword</title>

  <style>
    :root { --cell: 42px; --gap: 2px; }

    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin: 0;
      background:#fafafa;
      color:#111;
      overflow-x:hidden;
    }

    header{ padding:22px 16px 10px; max-width:1100px; margin:0 auto; text-align:center; }
    h1{ margin:0; font-size:30px; letter-spacing:.2px; }

    .intro{
      background:#fff;
      border:1px solid #ececec;
      border-radius:14px;
      padding:14px;
      box-shadow:0 6px 18px rgba(0,0,0,.04);
      max-width: 760px;
      margin: 12px auto 0;
    }
    .intro p{ margin:0 0 10px; font-size:15px; line-height:1.65; color:#222; }
    .intro p:last-of-type{ margin-bottom:0; }
    .footerNote{ font-size:12px; color:#666; margin-top:10px; }

    .wrap{
      display:grid;
      grid-template-columns: 1fr 360px;
      gap:18px;
      max-width:1100px;
      margin:0 auto;
      padding:0 16px 18px;
      align-items:start;
    }
    @media (max-width:980px){
      .wrap{ grid-template-columns:1fr; gap:12px; }
    }

    .card{
      background:#fff;
      border:1px solid #e7e7e7;
      border-radius:14px;
      box-shadow:0 6px 18px rgba(0,0,0,.06);
    }
    .gridCard{ padding:14px; }
    .cluesCard{ padding:14px; }

    /* Current clue bar */
    .clueBar{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      border:1px solid #eee;
      background:#fcfcfc;
      padding:10px 12px;
      border-radius:12px;
      margin-bottom:12px;
    }
    .clueBar .left{ min-width:0; }
    .clueBar .label{
      font-size:12px; color:#666; font-weight:800; letter-spacing:.3px;
      text-transform:uppercase;
    }
    .clueBar .text{
      margin-top:4px; font-size:13px; color:#111; line-height:1.25;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .clueBar .pill{
      font-size:12px; color:#444; font-weight:800;
      padding:5px 10px;
      border:1px solid #e6e6e6;
      border-radius:999px;
      background:#fff;
      flex:0 0 auto;
    }

    .gridWrap{
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      border-radius:12px;
    }

    .grid{
      display:grid;
      gap:var(--gap);
      justify-content:start;
      align-content:start;
      background:#111;
      padding:var(--gap);
      border-radius:12px;
      width:fit-content;
      max-width:100%;
    }

    .cell{
      width:var(--cell);
      height:var(--cell);
      background:#fff;
      position:relative;
    }
    .cell.black{ background:#111; }

    .num{
      position:absolute; top:3px; left:4px;
      font-size:10px; color:#111; opacity:.7; font-weight:800;
      pointer-events:none;
    }

    input.letter{
      width:100%; height:100%;
      border:0; outline:none;
      text-transform:uppercase;
      text-align:center;
      font-size:18px;
      font-weight:800;
      background:transparent;
      caret-color:transparent;
      padding:0;
    }

    .cell.selected{ outline:3px solid #111; outline-offset:-3px; }
    .cell.highlight{ background:#fff7cc; }
    .cell.wrong input{ color:#b00020; }
    .cell.correct input{ color:#111; }

    /* Wrong diagonal */
    .cell.wrong::after{
      content:"";
      position:absolute;
      inset:0;
      pointer-events:none;
      background: linear-gradient(135deg,
        transparent 49%,
        #b00020 50%,
        #b00020 51%,
        transparent 52%
      );
    }

    .tools{ display:flex; flex-wrap:wrap; gap:8px; margin:12px 0 0; }
    button{
      border:1px solid #ddd;
      background:#fff;
      padding:9px 10px;
      border-radius:10px;
      cursor:pointer;
      font-weight:700;
      font-size:13px;
    }
    button:hover{ background:#f3f3f3; }
    button.primary{ background:#111; color:#fff; border-color:#111; }
    button.primary:hover{ background:#222; }
    button.danger{ border-color:#f0c3c3; }
    button.success{ background:#16a34a; border-color:#16a34a; color:#fff; }
    button.success:hover{ background:#15803d; }
    .status{ margin-top:10px; font-size:13px; color:#333; }

    /* Clues */
    .clueCols{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    h2{ font-size:14px; margin:0 0 8px; letter-spacing:.2px; }
    ul{ margin:0; padding:0; list-style:none; }
    li{
      margin:6px 0;
      font-size:13px;
      color:#222;
      line-height:1.25;
      padding:6px 8px;
      border-radius:10px;
      cursor:pointer;
    }
    li:hover{ background:#f5f5f5; }
    li.active{ background:#fff7cc; }
    li span.answerLen{ color:#777; font-weight:700; margin-left:6px; font-size:12px; }

    /* Mobile clue tabs */
    .tabs{ display:none; gap:8px; margin-bottom:10px; }
    .tabBtn{ flex:1; }
    .tabBtn.active{ background:#111; border-color:#111; color:#fff; }
    @media (max-width:980px){
      .clueCols{ grid-template-columns:1fr; }
      .tabs{ display:flex; }
      .clueCols > div{ display:none; }
      .clueCols > div.activePanel{ display:block; }
      .clueBar .text{ white-space:normal; overflow:visible; text-overflow:clip; }
    }

    /* Modals */
    .modalBackdrop{
      position:fixed; inset:0;
     background: #ffffff;
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:999;
    }
    .modal{
      max-width:560px; width:100%;
      padding:18px;
      border-radius:16px;
      background:#fff;
      border:1px solid #eee;
      text-align:center;
    }
    .modal .row{
      display:flex; gap:10px; flex-wrap:wrap; justify-content:center;
      margin-top:14px;
    }

    /* Solved tick */
    .tick{
      width:74px; height:74px;
      border-radius:999px;
      background:#16a34a;
      display:grid;
      place-items:center;
      margin:4px auto 12px;
      box-shadow:0 10px 26px rgba(22,163,74,.25);
    }
    .tick svg{ width:42px; height:42px; }
    .modal h3{ margin:0 0 6px; font-size:20px; }
    .modal p{ margin:0 0 14px; color:#333; line-height:1.45; }

    /* Question modal */
    .questionModal{
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(255,255,255,.6);
    }
    .heartIcon{
      width:64px; height:64px;
      margin:6px auto 12px;
    }
    .heartIcon svg{ width:64px; height:64px; display:block; }
    .questionText{
      font-size:22px;
      line-height:1.35;
      color:#1a1a1a;
      font-weight:500;
      letter-spacing:.2px;
      padding:0 8px;
    }
  </style>
</head>
<body>

  <header>
    <h1>The Taawun Times Mini Crossword</h1>

    <div class="intro">
      <p><strong>Solve the crossword.</strong></p>
      <p>
        There are so many things I want to ask you but never get to it.
        I thought, with the 6 month anniversary of ours approaching soon,
        there is one question that I can ask.
      </p>
      <p>
        Anyways, I'm getting ahead of myself.
        Let's start with remembering our 6 months with each other.
      </p>
      <div class="footerNote">
        Tip: tap a square, type letters. Use arrows / backspace. Tap the same square again to switch Across/Down.
      </div>
    </div>
  </header>

  <main class="wrap">
    <section class="card gridCard">
      <div class="clueBar">
        <div class="left">
          <div class="label">Current clue</div>
          <div id="currentClue" class="text">Tap a square to begin.</div>
        </div>
        <div id="currentDir" class="pill">Across</div>
      </div>

      <div class="gridWrap">
        <div id="grid" class="grid" aria-label="crossword grid"></div>
      </div>

      <div class="tools">
        <button id="checkBtn" class="primary">Check</button>
        <button id="clearBtn" class="danger">Clear</button>
      </div>
      <div id="status" class="status"></div>
    </section>

    <aside class="card cluesCard">
      <div class="tabs">
        <button id="acrossTab" class="tabBtn active">Across</button>
        <button id="downTab" class="tabBtn">Down</button>
      </div>

      <div class="clueCols">
        <div id="acrossPanel" class="activePanel">
          <h2>Across</h2>
          <ul id="across"></ul>
        </div>
        <div id="downPanel">
          <h2>Down</h2>
          <ul id="down"></ul>
        </div>
      </div>
    </aside>
  </main>

  <!-- SOLVED MODAL -->
  <div id="modalBackdrop" class="modalBackdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="tick" aria-hidden="true">
        <svg viewBox="0 0 24 24" fill="none">
          <path d="M20 6L9 17l-5-5" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
      <h3>Congratulations</h3>
      <p>You solved the puzzle.</p>
      <div class="row">
        <button id="revealBtn" class="success">Reveal the question</button>
        <button id="closeBtn">Close</button>
      </div>
    </div>
  </div>

  <!-- QUESTION MODAL -->
  <div id="questionBackdrop" class="modalBackdrop" role="dialog" aria-modal="true">
    <div class="modal questionModal">
      <div class="heartIcon" aria-hidden="true">
        <svg viewBox="0 0 24 24">
          <path d="M12 21s-7-4.5-9.5-9C.5 8.5 2.5 6 5.5 6c1.7 0 3.2.9 4 2.2C10.3 6.9 11.8 6 13.5 6c3 0 5 2.5 3 6-2.5 4.5-9.5 9-9.5 9Z"
                fill="#5a0016"/>
        </svg>
      </div>
      <div class="questionText">Would you do me the honour of being my Valentine?</div>
<div class="row">
  <button id="yesBtn1" class="primary">Yes</button>
  <button id="yesBtn2" class="primary">Yes</button>
</div>
<!-- YES POPUP MODAL -->
<div id="yesBackdrop" class="modalBackdrop" role="dialog" aria-modal="true">
  <div class="modal questionModal">
    <div class="questionText">
      Sharam Karo, You will only click a button Yes? Come give me a kiss and then answer
    </div>
    <div class="row">
      <button id="yesCloseBtn" class="primary">Close</button>
    </div>
  </div>
</div>

  <!-- INTRO MODAL (shows on load) -->
  <div id="introBackdrop" class="modalBackdrop" role="dialog" aria-modal="true" style="display:flex;">
    <div class="modal">
      <h3 style="margin-top:4px;">Hey Jaan!</h3>
      <p style="font-size:15px; line-height:1.6; margin-top:10px;">
        There are so many things I want to ask you but never get to it. I thought, with the 6 month anniversary of ours approaching soon, there is one question that I can ask.
      </p>
      <p style="font-size:15px; line-height:1.6;">
        Anyways, I'm getting ahead of myself. Let's start with remembering our 6 months with each other. The question can wait till after.
      </p>
      <div class="row" style="margin-top:16px;">
        <button id="startBtn" class="primary">Start</button>
      </div>
    </div>
  </div>

  <script>
    // ---------------- DATA ----------------
    const FIXED_GRID = [
      "####################",
      "###P#######S########",
      "#Z#H##K####L#J######",
      "#A#O##H#NONE#A######",
      "#MATCHA####E#A######",
      "###O##LAPELPIN######",
      "###S##J#A#O###V#LIZ#",
      "######I#N#CLYDE##M##",
      "#####S##D#H###ITTA##",
      "###LETSGO#NBH#L##D##",
      "#####O##R#E#########",
      "#FOYER##A#SHEIN#####",
      "#####R####S#########",
      "####################",
    ];

    const CLUES = {
      KHALJI: "He is big, he is powerful, sometimes causes delays and for some reason intimidates your brother.",
      LETSGO: "Not quite on a knee, but my invite to forever.",
      PANDORA: "A gift from my travel, never adorned.",
      LAPELPIN: "Safi stands with UAE.",
      VEIL: "A part of your shaadi garment, I never got to see.",
      LOCHNESS: "Drenched pants, cold fingers and 3 rainbows later, never found.",
      LIZ: "Cat lady gardner of Oxfordshire.",
      CLYDE: "Moody's furry scottish cousin.",
      MATCHA: "A green slap to the face I only tolerate during the day.",
      ZAM: "Your local comfort food joint. Abbr.",
      NONE: "My favourite cheesecake topping.",
      SHEIN: "The order never placed.",
      ITTA: "How much do you love me?",
      IMAD: "The legend. The greatest. The hottest. The man that makes all men want to be him.",
      NBH: 'The "sweet" man of Malaz. Abbr.',
      STORR: "The old man that made you cry.",
      PHOTOS: "We will get to it someday...",
      FOYER: "Our next home improvement project (Inshallah).",
      JAAN: "Nabihah Abdul Hafeez, to me.",
      SLEEP: "I need much more of it my life.",
    };

    // ---------------- STATE ----------------
    let STATE = null;

    function $(id){ return document.getElementById(id); }
    function setStatus(msg){ $("status").textContent = msg; }

    // âœ… FIXED: removed escaping so template literal works in real JS
    function getCellEl(r,c){
      return document.querySelector(`.cell[data-r="${r}"][data-c="${c}"]`);
    }

    function escapeHtml(s){
      return (s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }
    function isMobile(){ return window.matchMedia("(max-width: 980px)").matches; }

    function setTab(dir){
      const acrossTab = $("acrossTab");
      const downTab   = $("downTab");
      const acrossPanel = $("acrossPanel");
      const downPanel   = $("downPanel");
      const isAcross = dir === "across";
      if(acrossTab) acrossTab.classList.toggle("active", isAcross);
      if(downTab) downTab.classList.toggle("active", !isAcross);
      if(acrossPanel) acrossPanel.classList.toggle("activePanel", isAcross);
      if(downPanel) downPanel.classList.toggle("activePanel", !isAcross);
    }

    function updateCellSize(){
      const cols = STATE?.cols ?? FIXED_GRID[0].length;
      const gap = 2;

      if(!isMobile()){
        document.documentElement.style.setProperty("--cell", "42px");
        return;
      }
      const sidePadding = 16 * 2;
      const cardPadding = 14 * 2;
      const available = Math.max(280, Math.min(window.innerWidth - sidePadding - cardPadding, 620));
      const cell = Math.floor((available - (cols + 1) * gap) / cols);
      const clamped = Math.max(28, Math.min(cell, 46));
      document.documentElement.style.setProperty("--cell", clamped + "px");
    }

    function buildFromFixed(){
      const grid = FIXED_GRID.map(row => row.split("").map(ch => ch === "#" ? null : ch));
      const rows = grid.length;
      const cols = grid[0].length;
      const isBlack = (r,c)=> grid[r][c] === null;

      const numbers = Array.from({length:rows}, ()=> Array.from({length:cols}, ()=> 0));
      let num = 1;
      for(let r=0;r<rows;r++){
        for(let c=0;c<cols;c++){
          if(isBlack(r,c)) continue;
          const startsAcross = (c===0 || isBlack(r,c-1)) && (c+1<cols && !isBlack(r,c+1));
          const startsDown   = (r===0 || isBlack(r-1,c)) && (r+1<rows && !isBlack(r+1,c));
          if(startsAcross || startsDown) numbers[r][c] = num++;
        }
      }

      const acrossList = [];
      const downList = [];

      for(let r=0;r<rows;r++){
        let c=0;
        while(c<cols){
          if(isBlack(r,c)){ c++; continue; }
          const start = c;
          while(c<cols && !isBlack(r,c)) c++;
          const word = grid[r].slice(start,c).join("");
          if(word.length>=3 && numbers[r][start]>0){
            acrossList.push({ number: numbers[r][start], answer: word, clue: CLUES[word] || "(missing clue)", r, c:start, dir:"across" });
          }
        }
      }

      for(let c=0;c<cols;c++){
        let r=0;
        while(r<rows){
          if(isBlack(r,c)){ r++; continue; }
          const start = r;
          while(r<rows && !isBlack(r,c)) r++;
          let word = "";
          for(let rr=start; rr<r; rr++) word += grid[rr][c];
          if(word.length>=3 && numbers[start][c]>0){
            downList.push({ number: numbers[start][c], answer: word, clue: CLUES[word] || "(missing clue)", r:start, c, dir:"down" });
          }
        }
      }

      STATE = {
        solved: false,
        solution: grid,
        numbers,
        rows, cols,
        acrossList: acrossList.sort((a,b)=>a.number-b.number),
        downList: downList.sort((a,b)=>a.number-b.number),
        selected: { r:0, c:0, dir:"across" }
      };

      updateCellSize();
      renderGrid();
      renderClues();
      setStatus("Ready. ðŸ’Œ");

      outer: for(let r=0;r<rows;r++){
        for(let c=0;c<cols;c++){
          if(STATE.solution[r][c]!==null){
            selectCell(r,c,"across", true);
            break outer;
          }
        }
      }
    }

    function renderGrid(){
      const { rows, cols, solution, numbers } = STATE;
      const gridEl = $("grid");
      gridEl.style.gridTemplateColumns = `repeat(${cols}, var(--cell))`;
      gridEl.innerHTML = "";

      for(let r=0;r<rows;r++){
        for(let c=0;c<cols;c++){
          const cellEl = document.createElement("div");
          cellEl.className = "cell" + (solution[r][c]===null ? " black" : "");
          cellEl.dataset.r = r;
          cellEl.dataset.c = c;

          if(solution[r][c]!==null){
            if(numbers[r][c]){
              const n = document.createElement("div");
              n.className = "num";
              n.textContent = numbers[r][c];
              cellEl.appendChild(n);
            }

            const inp = document.createElement("input");
            inp.className = "letter";
            inp.maxLength = 1;
            inp.autocomplete = "off";
            inp.spellcheck = false;
            inp.inputMode = "text";

            inp.addEventListener("focus", ()=> selectCell(r,c,STATE.selected.dir, true));
            inp.addEventListener("keydown", (e)=> onKey(e, r, c));
            inp.addEventListener("input", ()=> {
              inp.value = (inp.value || "").toUpperCase().replace(/[^A-Z]/g,"");

              // SMART: remove red slash only when correct
              const typed = (inp.value || "").toUpperCase();
              const correct = STATE.solution[r][c];

              if(typed && typed === correct){
                cellEl.classList.remove("wrong");
                cellEl.classList.add("correct");
              } else {
                cellEl.classList.remove("correct");
              }

              moveNext();
              checkWin(true);
            });

            cellEl.appendChild(inp);

            cellEl.addEventListener("click", ()=>{
              if(STATE.selected.r===r && STATE.selected.c===c){
                const newDir = STATE.selected.dir === "across" ? "down" : "across";
                selectCell(r,c,newDir,true);
              } else {
                selectCell(r,c,STATE.selected.dir,true);
              }
            });
          }

          gridEl.appendChild(cellEl);
        }
      }

      highlightCurrentWord();
    }

    function renderClues(){
      const acrossEl = $("across");
      const downEl = $("down");
      acrossEl.innerHTML = "";
      downEl.innerHTML = "";

      for(const item of STATE.acrossList){
        const li = document.createElement("li");
        li.dataset.dir = "across";
        li.dataset.number = String(item.number);
        li.innerHTML = `<strong>${item.number}.</strong> ${escapeHtml(item.clue)} <span class="answerLen">(${item.answer.length})</span>`;
        li.addEventListener("click", ()=> selectCell(item.r, item.c, "across", true));
        acrossEl.appendChild(li);
      }

      for(const item of STATE.downList){
        const li = document.createElement("li");
        li.dataset.dir = "down";
        li.dataset.number = String(item.number);
        li.innerHTML = `<strong>${item.number}.</strong> ${escapeHtml(item.clue)} <span class="answerLen">(${item.answer.length})</span>`;
        li.addEventListener("click", ()=> selectCell(item.r, item.c, "down", true));
        downEl.appendChild(li);
      }
    }

    function getWordStart(r,c,dir){
      const { solution } = STATE;
      if(solution[r][c]===null) return {r,c};
      if(dir==="across"){
        while(c>0 && solution[r][c-1]!==null) c--;
        return {r,c};
      } else {
        while(r>0 && solution[r-1][c]!==null) r--;
        return {r,c};
      }
    }

    function updateClueBar(){
      const { r, c, dir } = STATE.selected;
      const start = getWordStart(r,c,dir);
      const num = STATE.numbers[start.r][start.c];

      $("currentDir").textContent = dir === "across" ? "Across" : "Down";

      const listId = dir === "across" ? "across" : "down";
      const listEl = $(listId);
      const target = listEl.querySelector(`li[data-dir="${dir}"][data-number="${num}"]`);

      if(target){
        const clueText = target.textContent.replace(/^\s*\d+\.\s*/, "").replace(/\(\d+\)\s*$/, "").trim();
        $("currentClue").textContent = clueText;
      } else {
        $("currentClue").textContent = "Tap a square to begin.";
      }
    }

    function updateActiveClue(){
      const { r, c, dir } = STATE.selected;
      const start = getWordStart(r,c,dir);
      const num = STATE.numbers[start.r][start.c];

      document.querySelectorAll("li.active").forEach(li => li.classList.remove("active"));

      const listId = dir === "across" ? "across" : "down";
      const listEl = $(listId);
      const target = listEl.querySelector(`li[data-dir="${dir}"][data-number="${num}"]`);
      if(target){
        target.classList.add("active");
        target.scrollIntoView({ block: "nearest" });
      }

      if(isMobile()) setTab(dir);
      updateClueBar();
    }

    function selectCell(r,c,dir, focusInput=false){
      STATE.selected = { r,c,dir };

      document.querySelectorAll(".cell.selected").forEach(el=> el.classList.remove("selected"));
      const el = getCellEl(r,c);
      if(el) el.classList.add("selected");

      if(focusInput && el){
        const inp = el.querySelector("input.letter");
        if(inp) inp.focus({preventScroll:true});
      }

      highlightCurrentWord();
      updateActiveClue();
    }

    function highlightCurrentWord(){
      document.querySelectorAll(".cell.highlight").forEach(el=> el.classList.remove("highlight"));
      const { r, c, dir } = STATE.selected;
      const { solution, rows, cols } = STATE;
      if(solution[r][c]===null) return;

      let sr=r, sc=c;

      if(dir==="across"){
        while(sc>0 && solution[sr][sc-1]!==null) sc--;
        let cc=sc;
        while(cc<cols && solution[sr][cc]!==null){
          getCellEl(sr,cc)?.classList.add("highlight");
          cc++;
        }
      } else {
        while(sr>0 && solution[sr-1][sc]!==null) sr--;
        let rr=sr;
        while(rr<rows && solution[rr][sc]!==null){
          getCellEl(rr,sc)?.classList.add("highlight");
          rr++;
        }
      }
    }

    function onKey(e, r, c){
      const { solution } = STATE;
      if(solution[r][c]===null) return;

      const key = e.key;

      if(key==="ArrowLeft"){ e.preventDefault(); move(r,c,"left"); }
      else if(key==="ArrowRight"){ e.preventDefault(); move(r,c,"right"); }
      else if(key==="ArrowUp"){ e.preventDefault(); move(r,c,"up"); }
      else if(key==="ArrowDown"){ e.preventDefault(); move(r,c,"down"); }
      else if(key==="Backspace"){
        const inp = getCellEl(r,c).querySelector("input.letter");
        if(inp && inp.value){
          inp.value = "";
        } else {
          e.preventDefault();
          movePrev();
        }
        updateActiveClue();
      } else if(key==="Enter"){
        e.preventDefault();
        const newDir = STATE.selected.dir === "across" ? "down" : "across";
        selectCell(r,c,newDir,true);
      }
    }

    function move(r,c,dir){
      const { rows, cols, solution } = STATE;
      let rr=r, cc=c;

      const step = (d)=>{
        if(d==="left") cc--;
        if(d==="right") cc++;
        if(d==="up") rr--;
        if(d==="down") rr++;
      };

      step(dir);
      while(rr>=0 && cc>=0 && rr<rows && cc<cols){
        if(solution[rr][cc]!==null){
          const newDir = (dir==="left"||dir==="right") ? "across" : "down";
          selectCell(rr,cc,newDir,true);
          return;
        }
        step(dir);
      }
    }

    function moveNext(){
      const { r, c, dir } = STATE.selected;
      const { rows, cols, solution } = STATE;

      let rr = r, cc = c;
      if(dir==="across") cc++;
      else rr++;

      while(rr>=0 && cc>=0 && rr<rows && cc<cols){
        if(solution[rr][cc]===null) return;
        const inp = getCellEl(rr,cc)?.querySelector("input.letter");
        const val = (inp?.value || "").toUpperCase();
        if(!val){
          selectCell(rr,cc,dir,true);
          return;
        }
        if(dir==="across") cc++;
        else rr++;
      }
    }

    function movePrev(){
      const { r, c, dir } = STATE.selected;
      const { rows, cols, solution } = STATE;
      let rr=r, cc=c;
      if(dir==="across") cc--;
      else rr--;
      while(rr>=0 && cc>=0 && rr<rows && cc<cols){
        if(solution[rr][cc]!==null){
          selectCell(rr,cc,dir,true);
          return;
        }
        if(dir==="across") cc--;
        else rr--;
      }
    }

    function check(markWrong=true){
      const { rows, cols, solution } = STATE;
      let wrong = 0, filled = 0, total = 0;

      for(let r=0;r<rows;r++){
        for(let c=0;c<cols;c++){
          if(solution[r][c]===null) continue;
          total++;
          const el = getCellEl(r,c);
          const inp = el.querySelector("input.letter");
          const val = (inp.value || "").toUpperCase();

          // IMPORTANT: don't wipe wrong unless correct
          el.classList.remove("correct");

          if(val) filled++;

          if(val && val !== solution[r][c]){
            wrong++;
            if(markWrong) el.classList.add("wrong");
          } else if(val && val === solution[r][c]){
            el.classList.remove("wrong");
            el.classList.add("correct");
          } else {
            // empty cell: leave wrong as-is (or not), but do NOT mark correct
          }
        }
      }

      if(wrong===0 && filled===total){
        setStatus("Perfect! âœ…");
        showSolvedModal();
      } else {
        setStatus(`Filled ${filled}/${total}. Wrong squares: ${wrong}.`);
      }
    }

    function clearAll(){
      document.querySelectorAll("input.letter").forEach(i=> i.value="");
      document.querySelectorAll(".cell.wrong,.cell.correct").forEach(el=> el.classList.remove("wrong","correct"));
      STATE.solved = false;
      setStatus("Cleared.");
    }

    function checkWin(show=true){
      if(STATE && STATE.solved) return true;
      const { rows, cols, solution } = STATE;
      for(let r=0;r<rows;r++){
        for(let c=0;c<cols;c++){
          if(solution[r][c]===null) continue;
          const inp = getCellEl(r,c).querySelector("input.letter");
          if(((inp.value||"").toUpperCase()) !== solution[r][c]) return false;
        }
      }
      STATE.solved = true;
      if(show) showSolvedModal();
      return true;
    }

    function showSolvedModal(){ $("modalBackdrop").style.display = "flex"; }
    function closeModal(){ $("modalBackdrop").style.display = "none"; }

    function showQuestionModal(){ $("questionBackdrop").style.display = "flex"; }
    function closeQuestionModal(){ $("questionBackdrop").style.display = "none"; }

    function closeIntroModal(){ $("introBackdrop").style.display = "none"; }

    // ---------------- STARTUP (safe) ----------------
    document.addEventListener("DOMContentLoaded", () => {
      // build puzzle
      buildFromFixed();

      // hooks (safe checks so NOTHING can crash)
      $("checkBtn")?.addEventListener("click", ()=>check(true));
      $("clearBtn")?.addEventListener("click", clearAll);

      $("acrossTab")?.addEventListener("click", ()=> setTab("across"));
      $("downTab")?.addEventListener("click", ()=> setTab("down"));

      $("revealBtn")?.addEventListener("click", ()=>{
        closeModal();
        showQuestionModal();
      });

      function showYesModal(){ $("yesBackdrop").style.display = "flex"; }
function closeYesModal(){ $("yesBackdrop").style.display = "none"; }

$("yesBtn1")?.addEventListener("click", showYesModal);
$("yesBtn2")?.addEventListener("click", showYesModal);

$("yesCloseBtn")?.addEventListener("click", closeYesModal);
$("yesBackdrop")?.addEventListener("click", (e)=>{
  if(e.target.id === "yesBackdrop") closeYesModal();
});

      $("questionBackdrop")?.addEventListener("click", (e)=>{
        if(e.target.id === "questionBackdrop") closeQuestionModal();
      });

      $("closeBtn")?.addEventListener("click", closeModal);
      $("modalBackdrop")?.addEventListener("click", (e)=>{
        if(e.target.id==="modalBackdrop") closeModal();
      });

      $("startBtn")?.addEventListener("click", closeIntroModal);
      $("introBackdrop")?.addEventListener("click", (e)=>{
        if(e.target.id === "introBackdrop") closeIntroModal();
      });

      window.addEventListener("resize", updateCellSize);
      updateCellSize();
    });
  </script>
</body>
</html>



